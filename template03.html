<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mini-Solid2</title>
  </head>
  <body>
    <div id="app"></div>
    <script>
      let Listener
      function createSignal(value) {
        const s = {
          value,
          observers: null,
        };

        const setter = (value) => {
          return writeSignal(s, value)
        };

        return [readSignal.bind(s), setter]
      }
      
      function readSignal() {
        if (Listener) {
          if (!this.observers) {
            this.observers = [Listener]
          } else {
            this.observers.push(Listener)
          }
        }
        return this.value
      }

      function writeSignal(node, value,) {
        node.value = value
        if (node.observers && node.observers.length) {
            for (let i = 0; i < node.observers.length; i += 1) {
              const o = node.observers[i]
              o.fn()
            }
        }
        return value
      }

      function createEffect(fn) {
        Listener = { fn }
        fn()
        Listener = null
      }

      function template(html) {
        const t = document.createElement("template")
        t.innerHTML = html
        return t.content.firstChild.cloneNode(true)
      } 

      function render(component, parent) {
        parent.appendChild(component)
      }

      function insert(parent, accessor) {
        createEffect(() => {
          parent.textContent = accessor()
        })
      }

      const App = () => {
        const [count, setCount] = createSignal(0)
        const el = template('<button></button>')
        el.addEventListener('click', () => {
          setCount(520)
        })
        insert(el, count)
        return el
      }
      const root = document.getElementById('app')
      render(App(), root)
    </script>
  </body>
</html>